<!DOCTYPE html>
<html
	lang="en"
	class="light-style layout-menu-fixed"
	dir="ltr"
	data-theme="theme-default"
	data-assets-path="assets/"
	data-template="vertical-menu-template-free"
	>
	<head>
		<link id="core" rel="stylesheet" href="" class="template-customizer-core-css" />
		<link id="theme" rel="stylesheet" href="" class="template-customizer-theme-css" />
		<script>
			var pn = localStorage.getItem("em")
			var cid  = localStorage.getItem("nclz")
		</script>
		<script src="assets/vendor/libs/jquery/jquery.js"></script>
		<link rel="stylesheet" href="js/MCDatepicker-master/dist/mc-calendar.min.css">
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
			/>
		<title>Change Password - English RE</title>
		<meta name="description" content="" />
		<!-- Favicon -->
		<link rel="icon" type="image/x-icon" href="images/icon.png" />
		<!-- Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
			rel="stylesheet"
			/>
		<!-- Icons. Uncomment required icon fonts -->
		<link rel="stylesheet" href="assets/vendor/fonts/boxicons.css" />
		<script src="js/pdf.js"></script>
		<script src="js/jspdf.plugin.autotable.js"></script>
		<!-- Core CSS -->
		<script src="js/sweetalert2@11.js"></script>
		<link rel="stylesheet" href="" id="swd">
		<script>
			if(localStorage.getItem("theme")=="dark"){
							
							document.getElementById("core").href = "assets/vendor/css/core-dark.css"
								document.getElementById("theme").href = "assets/vendor/css/theme-default-dark.css"
								document.getElementById("swd").href = "assets/css/dark.css"
						} else{
							document.getElementById("core").href = "assets/vendor/css/core.css"
								document.getElementById("theme").href = "assets/vendor/css/theme-default.css"
						}
		</script>
		<style>
			.section::-webkit-scrollbar {
			width: 20px;
			}
			.section::-webkit-scrollbar-track {
			background-color: #e4e4e4;
			border-radius: 100px;
			}
			.section::-webkit-scrollbar-thumb {
			border-radius: 100px;
			border: 6px solid rgba(0, 0, 0, 0.18);
			border-left: 0;
			border-right: 0;
			background-color: #8070d4;
			}
			.hellocen{ align-self: center!important;align-items: center!important;align-content: center!important; text-align: center!important;
			}
			.margin-r-5{
			margin-right: 5px;
			}
		</style>
		<link rel="stylesheet" href="assets/css/demo.css" />
		<!-- Vendors CSS -->
		<link rel="stylesheet" href="assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
		<!-- Page CSS -->
		<!-- Helpers -->
		<script src="assets/vendor/js/helpers.js"></script>
		<!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
		<!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
		<script src="assets/js/config.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.2.8/firebase-app.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.2.8/firebase-auth.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.2.8/firebase-database.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="/admin/config.js"></script>
	</head>
	<style>
		.w3-green,.w3-hover-green:hover{color:#fff!important;background-color:#4CAF50!important}
	</style>
	<body>
		<!-- Layout wrapper -->
		<div class="layout-wrapper layout-content-navbar">
		<div class="layout-container">
		<!-- Menu -->
		<aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
			<div class="app-brand demo">
				<a href="/" class="app-brand-link">
				<span class="app-brand-logo demo">
				<img src="images/LMS-Logo.png" width="10%" alt="English-RE-Logo">
				</span>
				</a>
				<a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto d-block d-xl-none">
				<i class="bx bx-chevron-left bx-sm align-middle"></i>
				</a>
			</div>
			<div class="menu-inner-shadow"></div>
			<ul class="menu-inner py-1">
				<!-- Dashboard -->
				<li class="menu-item">
					<a href="/" class="menu-link">
						<i class="menu-icon tf-icons bx bx-home-circle"></i>
						<div data-i18n="Dashboard">Dashboard</div>
					</a>
				</li>
				<!-- Classes -->
				<li class="menu-item">
					<a href="javascript:void(0);" class="menu-link menu-toggle">
						<i class="menu-icon tf-icons bx bx-chalkboard"></i>
						<div data-i18n="Layouts">Classes</div>
					</a>
					<ul id="ulclz" class="menu-sub" style="cursor: pointer;">
					</ul>
				</li>
				<!-- Class Settings -->
				<li class="menu-item">
					<a href="class-settings" class="menu-link">
						<i class="menu-icon tf-icons bx bx-cog"></i>
						<div data-i18n="Class Settings">Class Settings</div>
					</a>
				</li>
				<!-- Exams -->
				<li class="menu-item">
					<a href="exmain" class="menu-link">
						<i class="menu-icon tf-icons bx bx-stopwatch"></i>
						<div data-i18n="Exams">Exams</div>
					</a>
				</li>
				<!-- Bank Payments -->
				<li class="menu-item">
					<a href="bank-payments" class="menu-link">
						<i class="menu-icon tf-icons bx bx-credit-card"></i>
						<div data-i18n="Bank Payments">Bank Payments</div>
					</a>
				</li>
				<!-- Coupens -->
				<!--<li class="menu-item">
					<a href="coupens" class="menu-link">
						<i class="menu-icon tf-icon bx bxs-coupon"></i>
						<div data-i18n="Coupens">Coupens</div>
					</a>
					</li>-->
				<!-- Reports -->
				<li class="menu-item">
					<a href="javascript:void(0);" class="menu-link menu-toggle">
						<i class="menu-icon tf-icons bx bxs-report"></i>
						<div data-i18n="Reports">Reports</div>
					</a>
					<ul class="menu-sub">
						<li class="menu-item">
							<a href="meeting-reports" class="menu-link">
								<div data-i18n="Meeting Reports">Meeting Reports</div>
							</a>
						</li>
						<li class="menu-item">
							<a href="payment-reports" class="menu-link">
								<div data-i18n="Payment Reports">Payment Reports</div>
							</a>
						</li>
					</ul>
				</li>
				<!-- Students -->
				<li class="menu-item active open">
					<a href="javascript:void(0);" class="menu-link menu-toggle">
						<i class="menu-icon tf-icons bx bxs-report"></i>
						<div data-i18n="Reports">Students</div>
					</a>
					<ul class="menu-sub">
						<li class="menu-item">
							<a href="students" class="menu-link">
								<div data-i18n="Students">All Students</div>
							</a>
						</li>
						<li class="menu-item">
							<a href="filter-students" class="menu-link">
								<div data-i18n="Students">Filter Students</div>
							</a>
						</li>
                        <li class="menu-item active">
							<a href="st-change-password" class="menu-link">
								<div data-i18n="Students">Change Password</div>
							</a>
						</li>
					</ul>
				</li>
				<!-- Settings -->
				<li class="menu-header small text-uppercase">
					<span class="menu-header-text">Settings</span>
				</li>
				<li class="menu-item">
					<a href="edit-profile" class="menu-link">
						<i class="menu-icon tf-icons bx bxs-user"></i>
						<div data-i18n="Edit Profile">Edit Profile</div>
					</a>
				</li>
				<li class="menu-item">
					<a href="account-settings" class="menu-link">
						<i class="menu-icon tf-icons bx bxs-wrench"></i>
						<div data-i18n="Account Settings">Account Settings</div>
					</a>
				</li>
				</li>
				<!-- Support -->
				<li class="menu-header small text-uppercase"><span class="menu-header-text">Support</span></li>
				<li class="menu-item">
					<a href="manage-servers" class="menu-link">
						<i class="menu-icon tf-icons bx bx-server"></i>
						<div data-i18n="Documentation">Manage Servers</div>
					</a>
				</li>
				<li class="menu-item">
					<a href="#" class="menu-link">
						<i class="menu-icon tf-icons bx bx-support"></i>
						<div data-i18n="Support">Support Center</div>
					</a>
				</li>
			</ul>
		</aside>
		<!-- / Menu -->
		<!-- Layout container -->
		<div class="layout-page">
			<!-- Navbar -->
			<nav 
				class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
				id="layout-navbar"
				>
				<div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
					<a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
					<i class="bx bx-menu bx-sm"></i>
					</a>
				</div>
				<div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
					<!-- Search -->
					<div class="navbar-nav align-items-center">
						<div class="nav-item d-flex align-items-center">
							<i class="bx bx-search fs-4 lh-0"></i>
							<input
								type="text"
								class="form-control border-0 shadow-none"
								placeholder="Search..."
								aria-label="Search..."
								/>
						</div>
					</div>
					<!-- /Search -->
					<ul class="navbar-nav flex-row align-items-center ms-auto">
						<!-- Place this tag where you want the button to render. -->
						<!--Disply Time-->
						<span id="live_time" class="badge bg-label-primary rounded-pill" style="font-size: 16px;">Updating</span>
						<script>
							setInterval(myTimer, 1000);
							
							function myTimer() {
							const ddd = new Date();
							document.getElementById("live_time").innerHTML = ddd.toLocaleTimeString();
							}
						</script>
						<li class="nav-item lh-1 me-3">
						</li>
						<!-- User -->
						<script>
							function themic (){
								if(document.getElementById("theme").href.includes("dark")){
									document.getElementById("core").href = "assets/vendor/css/core.css"
									document.getElementById("theme").href = "assets/vendor/css/theme-default.css"
									localStorage.setItem("theme","light")
								} else{
									document.getElementById("core").href = "assets/vendor/css/core-dark.css"
									document.getElementById("theme").href = "assets/vendor/css/theme-default-dark.css"
									document.getElementById("swd").href = "assets/css/dark.css"
									localStorage.setItem("theme","dark")
								}
							}
									
						</script>
						<li class="nav-item me-2 me-xl-0">
							<a class="nav-link style-switcher-toggle hide-arrow" href="javascript:void(0);" onclick="themic()" data-bs-original-title="" title="">
							<i class="bx bx-sm bx-sun"></i>
							</a>
						</li>
						<li class="nav-item navbar-dropdown dropdown-user dropdown">
							<a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
								<div class="avatar avatar-online">
									<img id="dp" src="assets/img/icons/1.png" alt class="w-px-60 h-auto rounded-circle" />
								</div>
							</a>
							<ul class="dropdown-menu dropdown-menu-end">
								<li>
									<a class="dropdown-item" href="#">
										<div class="d-flex">
											<div class="flex-shrink-0 me-3">
												<div class="avatar avatar-online">
													<img id="dp2"src="assets/img/icons/1.png" alt class="w-px-40 h-auto rounded-circle" />
												</div>
											</div>
											<div class="flex-grow-1">
												<span id="name2" class="fw-semibold d-block">Loading..</span>
												<small class="text-muted">Admin</small>
											</div>
										</div>
									</a>
								</li>
								<li>
									<div class="dropdown-divider"></div>
								</li>
								<li>
									<a class="dropdown-item" href="edit-profile">
									<i class="bx bxs-user me-2"></i>
									<span class="align-middle">Edit Profile</span>
									</a>
								</li>
								<li>
									<a class="dropdown-item" href="account-settings">
									<i class="bx bxs-cog me-2"></i>
									<span class="align-middle">Account Settings</span>
									</a>
								</li>
								<li>
									<div class="dropdown-divider"></div>
								</li>
								<li>
									<a class="dropdown-item" id="logout" style="cursor: pointer;">
										<i class="bx bx-power-off me-2"></i>
										<script>
											document.getElementById("logout").onclick=function(){
												firebase.auth().signOut()
												  st.auth().signOut()
												  location.replace("/");
											};
										</script>
										<span class="align-middle">Log Out</span>
									</a>
								</li>
							</ul>
						</li>
						<!--/ User -->
					</ul>
				</div>
			</nav>
			<!-- / Navbar -->
			<!-- Content wrapper -->
			<div class="content-wrapper">
				<!-- Content -->
				<div class="container-xxl flex-grow-1 container-p-y">
					<div class="row">
						<div class="col-md-12">
							<script>
								// Create Base64 Object
								var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}}

                                // Step 1: Open a sweet alert with input to enter the id
								Swal.fire({
								title: "Enter Student ID",
								input: "number",
								inputPlaceholder: "Enter ID",
								inputAttributes: {
									autocapitalize: "off"
								},
								showCancelButton: true,
								confirmButtonText: "Get Password",
								showLoaderOnConfirm: true,
								preConfirm: (id) => {
									// Step 2: Get password from firebase database
									
									const passwordRef = firebase.database().ref("students/" + id + "/pw");
									return passwordRef.once("value").then((snapshot) => {
									const password = snapshot.val();

									if (password != null) {
										// Step 3: Display the Current Password with a Sweet Alert
										Swal.fire({
											title: "Current Password",
											text: password,
											showCancelButton: true,
											confirmButtonText: "Change Password"
										}).then((result) => {
											if (result.isConfirmed) {
												// Step 4: Open a sweet alert to enter new password
												Swal.fire({
													title: "Enter New Password",
													input: "password",
													inputPlaceholder: "Enter New Password",
													inputAttributes: {
														autocapitalize: "off"
													},
													showCancelButton: true,
													confirmButtonText: "Save",
													showLoaderOnConfirm: true,
													preConfirm: (newPassword) => {
													// Step 5: When New Password is entered
													if (newPassword.length < 6) {
														swal.fire({
															title: "Weak Password",
															text: "The password must be a string with at least 6 characters.",
															showCancelButton: false,
															confirmButtonText: "Try Again"
														}).then((result) => {
																location.reload()
														})
													} else {
														Swal.fire({
														icon: "info",
														title: "Updating Password...",
														showConfirmButton:false,
														allowEscapeKey:false,
														allowOutsideClick:false,
														allowEnterKey:false
													})

													// 1st -> Update the password in Firebase auth with email via above Server
													const phoneNumber = firebase.database().ref("students/" + id + "/pn").once("value").then((snapshot) => {
														return snapshot.val() + "@englishre.xyz";
													});

													const phoneNumberRef = firebase.database().ref("students/" + id + "/pn");
													phoneNumberRef.on('value', (snapshot) => {
													const phoneNumber = snapshot.val();
													email = phoneNumber + '@englishre.xyz'

													console.log(email)

													fetch("https://server-02.englishre.xyz/changepassword", {
														method: "POST",
														headers: {
															"Content-Type": "application/json"
														},
														body: JSON.stringify({
															email: email,
															newPassword: newPassword
														})
													}).then(response => {
														console.log(response)

														// 1st -> snapshot and decrypt firebase data

														const pNinBase64 = Base64.encode(phoneNumber)
														const pNinUri = encodeURIComponent(pNinBase64)
														console.log(phoneNumber)
														console.log(pNinBase64)
														console.log(pNinUri)

														const encryptedDataRef = st.database().ref("students/" + pNinUri + '/data');
														return encryptedDataRef.once("value").then((snapshot) => {
															const encryptedData = snapshot.val();
															console.log(encryptedData)
															console.log('Old Password: ' + password)
															const passwordBytes = CryptoJS.AES.decrypt(encryptedData, password);
															console.log('Password Bytes ->' + passwordBytes)
															decryptedData = passwordBytes.toString(CryptoJS.enc.Utf8);
															console.log('Decrypted Data ->' + decryptedData)
															var jsonData = JSON.parse(decryptedData);
															console.log('JSON Data ->' + jsonData)
															jsonData.pw = newPassword;
															console.log('New JSON Data ->' + jsonData)


															// Encrypt Decrypted data with new password and update in the above path
															decryptedData = JSON.stringify(jsonData)
															console.log(decryptedData)
															encryptedDataNewPassword = CryptoJS.AES.encrypt(decryptedData, newPassword).toString();
															console.log(encryptedDataNewPassword)
															encryptedDataRef.set(encryptedDataNewPassword);

															// 2nd -> Update the password in firebase database
															passwordRef.set(newPassword);

															// 4th -> Sweet Alert data in firebase path ("students" + id) in a list with Success text
															const dataRef = firebase.database().ref("students/" + id);
															dataRef.once("value").then((snapshot) => {
															const data = snapshot.val();
															Swal.fire({
																title: "Password Changed Successfully",
																html: `<ul>
																		<li>ID: ${id}</li>
																		<li>Name: ${data.fn} ${data.ln}</li>
																		<li>Phone: ${data.pn}</li>
																		<li>Password: ${data.pw}</li>
																	</ul>`
																});
															});
														});
													}).catch(error => {
														console.log(error);
														Swal.fire({
															title: "Error Updating Password in Firebase Auth",
															text: error,
															showCancelButton: false,
															confirmButtonText: "Try Again"
														}).then((result) => {
															location.reload()
														})
													});
													})
													}
												}
												});
											}
										});
									} else {
										Swal.fire({
											title: "Student Not Found!",
											text: "Couldn't Find a Student with Provided Student ID \n Enter Student ID without leading 0s and prefix 'RE'.",
											showCancelButton: true,
											confirmButtonText: "Try With Different ID"
										}).then((result) => {
												location.reload()
										})
									}
									}).catch(() => {
									Swal.showValidationMessage("Invalid ID");
									});
								}
								});

                            </script>
						</div>
					</div>
				</div>
				<!-- / Content -->
				<footer class="content-footer footer bg-footer-theme">
					<div class="container-fluid d-flex flex-wrap justify-content-between py-2 flex-md-row flex-column">
						<div class="mb-2 mb-md-0">
							&copy; Copyright
							<script>
								document.write(new Date().getFullYear());
							</script>
							, Made with ❤️ by
							<a href="https://themeselection.com" target="_blank" class="footer-link fw-bolder">Nadeeja Kalhara & Chandira Anupama</a>
						</div>
						<div>
							<a href="https://themeselection.com/license/" class="footer-link me-4" target="_blank">License</a>
							<a href="https://themeselection.com/" target="_blank" class="footer-link me-4">More Themes</a>
							<a
								href="https://themeselection.com/demo/sneat-bootstrap-html-admin-template/documentation/"
								target="_blank"
								class="footer-link me-4"
								>Documentation</a
								>
							<a
								href="https://github.com/themeselection/sneat-html-admin-template-free/issues"
								target="_blank"
								class="footer-link me-4"
								>Support</a
								>
						</div>
					</div>
				</footer>
				<!-- / Layout page -->
			</div>
			<!-- Overlay -->
			<div class="layout-overlay layout-menu-toggle"></div>
		</div>
		<!-- / Layout wrapper -->
		<!-- Core JS -->
		<!-- build:js assets/vendor/js/core.js -->
		<script src="assets/vendor/libs/popper/popper.js"></script>
		<script src="assets/vendor/js/bootstrap.js"></script>
		<script src="assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
		<script src="assets/vendor/js/menu.js"></script>
		<!-- endbuild -->
		<!-- Vendors JS -->
		<!-- Main JS -->
		<script src="js/logged-out-redirect.js"></script>
		<script src="assets/js/main.js"></script>
		<script src="js/setclasslist.js"></script>
		<style>
			input {
			border: #8070d4;
			}
			th, td { white-space: nowrap; }
			div.dataTables_wrapper {
			width: 800px;
			margin: 0 auto;
			}
		</style>
		<!-- Page JS -->
		<!-- Place this tag in your head or just before your close body tag. -->
		<script async defer src="https://buttons.github.io/buttons.js"></script>
		<!-- Code injected by live-server -->
	</body>
</html>